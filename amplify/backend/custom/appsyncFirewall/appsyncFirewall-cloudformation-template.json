{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Parameters": {
    "env": {
      "Type": "String"
    },
    "apiteamGraphQLAPIIdOutput": {
      "Type": "String",
      "Description": "Input parameter describing GraphQLAPIIdOutput attribute for api/team resource"
    }
  },
  "Resources": {
    "appSyncFirewallAssociation": {
      "Type" : "AWS::WAFv2::WebACLAssociation",
      "Properties" : {
        "ResourceArn": {
          "Fn::Sub": "arn:${AWS::Partition}:appsync:${AWS::Region}:${AWS::AccountId}:apis/${apiteamGraphQLAPIIdOutput}"
        },
        "WebACLArn": { 
          "Fn::GetAtt": ["appSyncFirewall", "Arn"]
        }
      }
    },
    "appSyncFirewall": {
      "Type": "AWS::WAFv2::WebACL",
      "Properties": {
        "Description": "Web ACL for TEAM AppSync API",
        "Scope": "REGIONAL",
        "Name": {
          "Fn::Sub": "teamAppSyncApiFirewallACL-${env}"
        },
        "DefaultAction": {
          "Allow": {}
        },
        "VisibilityConfig": {
          "SampledRequestsEnabled": true,
          "CloudWatchMetricsEnabled": true,
          "MetricName": "teamAppSyncApiFirewallACLMetric"
        },
        "Rules": [
          {
            "Name": "AWS-CRS",
            "Priority": 0,
            "Statement": {
              "ManagedRuleGroupStatement": {
                "VendorName": "AWS",
                "Name": "AWSManagedRulesCommonRuleSet"
              }
            },
            "OverrideAction": {
                "Count": {}
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": {
                "Fn::Sub": "teamAppSyncApiFirewall-${env}-aws-crs-metric"
              }
            }
          },
          {
            "Name": "Bad-Inputs",
            "Priority": 1,
            "Statement": {
              "ManagedRuleGroupStatement": {
                "VendorName": "AWS",
                "Name": "AWSManagedRulesKnownBadInputsRuleSet"
              }
            },
            "OverrideAction": {
              "Count": {}
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": {
                "Fn::Sub": "teamAppSyncApiFirewall-${env}-bad-inputs-metric"
              }
            }
          },
          {
            "Name": "Anonymous-IpList",
            "Priority": 2,
            "Statement": {
              "ManagedRuleGroupStatement": {
                "VendorName": "AWS",
                "Name": "AWSManagedRulesAnonymousIpList"
              }
            },
            "OverrideAction": {
              "Count": {}
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": {
                "Fn::Sub": "teamAppSyncApiFirewall-${env}-anonymous-iplist-metric"
              }
            }
          },
          {
            "Name": "SQLInject-RuleSet",
            "Priority": 3,
            "Statement": {
              "ManagedRuleGroupStatement": {
                "VendorName": "AWS",
                "Name": "AWSManagedRulesSQLiRuleSet"
              }
            },
            "OverrideAction": {
              "Count": {}
            },
            "VisibilityConfig": {
              "SampledRequestsEnabled": true,
              "CloudWatchMetricsEnabled": true,
              "MetricName": {
                  "Fn::Sub": "teamAppSyncApiFirewall-${env}-SQLinjection-ruleset-metric"
              }
            }
          },
          {
            "Name": "RateBased-CountIpRule",
            "Priority": 4,
            "Statement": {
              "RateBasedStatement": {
                "Limit": 100,
                "AggregateKeyType": "IP"
              }
            },
            "Action": {
              "Count": {}
            },
            "VisibilityConfig": {
              "CloudWatchMetricsEnabled": true,
              "MetricName": {
                "Fn::Sub": "teamAppSyncApiFirewall-${env}-RateBased-CountIp-ruleset-metric"
              },
              "SampledRequestsEnabled": true
            }
          }
        ]
      }
    }
  },
  "Outputs": {}
}